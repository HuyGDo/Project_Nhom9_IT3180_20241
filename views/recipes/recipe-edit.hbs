<main class="create-recipe">
    <div class="create-recipe__container">
        <h1 class="create-recipe__heading">Edit Recipe</h1>

        <form id="editRecipeForm" class="create-recipe__form" enctype="multipart/form-data">
            {{!-- Basic Info --}}
            <div class="form-group">
                <h2 class="section-title">Basic Information</h2>
                <div class="form-group">
                    <label for="recipe-image">Recipe Image</label>
                    <div class="image-upload">
                        <div class="image-upload__preview">
                            <img
                                src="{{#if recipe.image}}{{
                                    recipe.image
                                }}{{else}}/assets/img/recipe-placeholder.jpg{{/if}}"
                                alt="Recipe preview"
                                id="imagePreview"
                            />
                        </div>
                        <div class="image-upload__input">
                            <input
                                type="file"
                                id="recipe-image"
                                name="recipe-image"
                                accept="image/*"
                                class="image-upload__file"
                                onchange="previewImage(this)"
                            />
                            <label for="recipe-image" class="image-upload__label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>Choose an image</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="title">Recipe Title</label>
                    <input
                        type="text"
                        id="title"
                        name="title"
                        value="{{ recipe.title }}"
                        placeholder="Enter your recipe title"
                        required
                    />
                </div>
                <div class="form-group">
                    <label for="description">Recipe Description</label>
                    <textarea
                        id="description"
                        name="description"
                        placeholder="Describe your recipe..."
                        required
                        >{{ recipe.description }}</textarea
                    >
                </div>
            </div>

            {{!-- Cooking Info --}}
            <div class="form-group">
                <h2 class="section-title">Cooking Information</h2>
                <div class="create-recipe__form__item--row">
                    <div class="form-group">
                        <label for="prepTime">Prep Time (minutes)</label>
                        <input
                            type="number"
                            id="prepTime"
                            name="prepTime"
                            value="{{ recipe.prepTime }}"
                            min="0"
                            required
                        />
                    </div>
                    <div class="form-group">
                        <label for="cookTime">Cook Time (minutes)</label>
                        <input
                            type="number"
                            id="cookTime"
                            name="cookTime"
                            value="{{ recipe.cookTime }}"
                            min="0"
                            required
                        />
                    </div>
                    <div class="form-group">
                        <label for="servings">Servings</label>
                        <input
                            type="number"
                            id="servings"
                            name="servings"
                            value="{{ recipe.servings }}"
                            min="1"
                            required
                        />
                    </div>
                </div>
            </div>

            {{!-- Ingredients --}}
            <div class="form-group">
                <h2 class="section-title">Ingredients</h2>
                <div class="ingredients-list" id="ingredientsList">
                    {{#each recipe.ingredients}}
                    <div class="ingredient-item">
                        <input
                            type="text"
                            name="ingredients[{{@index}}][name]"
                            value="{{ this.name }}"
                            placeholder="Ingredient name"
                            required
                        />
                        <input
                            type="text"
                            name="ingredients[{{@index}}][quantity]"
                            value="{{ this.quantity }}"
                            placeholder="Amount (e.g., 2 cups)"
                            required
                        />
                        <button type="button" class="remove-btn">&times;</button>
                    </div>
                    {{/each}}
                </div>
                <button type="button" class="btn btn--add" id="addIngredient">
                    Add Another Ingredient
                </button>
            </div>

            {{!-- Instructions --}}
            <div class="form-group">
                <h2 class="section-title">Cooking Instructions</h2>
                <div id="instructionsList">
                    {{#each recipe.instructions}}
                    <div class="instruction-item">
                        <span class="instruction-number">{{add @index 1}}</span>
                        <input
                            type="text"
                            name="instructions[{{@index}}][description]"
                            value="{{ this.description }}"
                            placeholder="Enter cooking instruction"
                            required
                        />
                        <button type="button" class="remove-btn">&times;</button>
                    </div>
                    {{/each}}
                </div>
                <button type="button" id="addInstruction" class="btn btn--add">Add Step</button>
            </div>

            <div class="create-recipe__form__actions">
                <div class="create-recipe__form__buttons">
                    <button type="submit" class="btn btn--primary create-recipe__form__submit">
                        <i class="fas fa-save"></i>
                        Save Changes
                    </button>
                    <a
                        href="/users/me/stored/recipes"
                        class="btn btn--outline create-recipe__form__cancel"
                    >
                        <i class="fas fa-times"></i>
                        Cancel
                    </a>
                </div>
            </div>
        </form>
    </div>
</main>

<script>
    // Add dynamic fields for ingredients
    const ingredientsList = document.getElementById("ingredientsList");
    const addIngredientBtn = document.getElementById("addIngredient");
    let ingredientCount = {{recipe.ingredients.length}};

    addIngredientBtn.addEventListener("click", () => {
        const newIngredient = document.createElement("div");
        newIngredient.className = "ingredient-item";
        newIngredient.innerHTML = `
            <input
                type="text"
                name="ingredients[${ingredientCount}][name]"
                placeholder="Enter ingredient"
                required
            >
            <input
                type="text"
                name="ingredients[${ingredientCount}][quantity]"
                placeholder="Amount (e.g., 2 cups)"
                required
            >
            <button type="button" class="remove-btn">&times;</button>
        `;
        ingredientsList.appendChild(newIngredient);
        ingredientCount++;
    });

    // Add dynamic fields for instructions
    const instructionsList = document.getElementById("instructionsList");
    const addInstructionBtn = document.getElementById("addInstruction");
    let instructionCount = {{recipe.instructions.length}};

    addInstructionBtn.addEventListener("click", () => {
        const newInstruction = document.createElement("div");
        newInstruction.className = "instruction-item";
        newInstruction.innerHTML = `
            <span class="instruction-number">${instructionCount + 1}</span>
            <input
                type="text"
                name="instructions[${instructionCount}][description]"
                placeholder="Enter cooking instruction"
                required
            >
            <button type="button" class="remove-btn">&times;</button>
        `;
        instructionsList.appendChild(newInstruction);
        instructionCount++;
        updateInstructionNumbers();
    });

    function updateInstructionNumbers() {
        const instructions = document.querySelectorAll(".instruction-item");
        instructions.forEach((item, index) => {
            const numberSpan = item.querySelector(".instruction-number");
            if (numberSpan) {
                numberSpan.textContent = index + 1;
            }

            const input = item.querySelector("input");
            if (input) {
                input.name = `instructions[${index}][description]`;
            }
        });
    }

    // Remove items
    document.addEventListener("click", (e) => {
        if (e.target.classList.contains("remove-btn")) {
            e.target.parentElement.remove();
            if (e.target.closest("#instructionsList")) {
                instructionCount--;
                updateInstructionNumbers();
            }
        }
    });

    function previewImage(input) {
        const preview = document.getElementById("imagePreview");
        const file = input.files[0];

        if (file) {
            const reader = new FileReader();

            reader.onload = function (e) {
                preview.src = e.target.result;
            };

            reader.readAsDataURL(file);
        }
    }

    // Add this new code for form submission
    const form = document.getElementById('editRecipeForm');
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(form);

        try {
            const response = await fetch('/recipes/{{ recipe._id }}?_method=PUT', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (response.ok) {
                alert('Recipe updated successfully!');
                window.location.href = '/users/me/stored/recipes';
            } else {
                alert(result.message || 'Error updating recipe');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error updating recipe');
        }
    });
</script>
